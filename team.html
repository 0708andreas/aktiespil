<html>
    <head>
        <title>Team</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
        <script src="http://canvasjs.com/assets/script/canvasjs.min.js"></script>
        <script>        
            var state;
            var aktier = {};
            var socket = io();
            //var teamname = prompt("Indtast et teamnavn. Hvis du skriver et navn, der er i brug, bliver du logget ind på det team.");
            var teamname = "team1";
            socket.emit("sign_in", teamname);
            socket.on("own_details", function(msg) {
                state = msg;
                document.querySelector("#status").innerHTML = JSON.stringify(msg);
                console.log(state)
            });
            
            socket.on("update_aktier", function(msg) {
                aktier = msg;
                var nextMoney = state['money'];
                if (document.querySelector('#sell_toggle').checked) {
                    var sel = document.querySelector('#sell_aktie');
                    var aktie = sel.options[sel.selectedIndex].value;
                    var amount = parseInt(document.querySelector("#sell_amount").value);
                    nextMoney += aktier[aktie] * amount;
                }
                if (document.querySelector('#buy_toggle').checked) {
                    var sel = document.querySelector('#buy_aktie');
                    var aktie = sel.options[sel.selectedIndex].value;
                    var amount = parseInt(document.querySelector("#buy_amount").value);
                    nextMoney -= aktier[aktie] * amount;
                }
                if (document.querySelector('#sell_toggle').checked || document.querySelector('#buy_toggle').checked) {
                    document.querySelector('#forecast').style.display = 'block';
                    document.querySelector('#nextMoney').innerHTML = nextMoney;
                } else {
                    document.querySelector('forecast').style.display = 'none';
                }
            });
            socket.on('error_msg', function (msg) {
                console.log("Error: " + msg)
                alert("Der skete en fejl: " + msg);
            })
            
            function buy_sell_action() {
                if (document.querySelector('#buy_toggle').checked && document.querySelector('#sell_toggle').checked) {
                    //Oh dear, this math is complicated. I'll get back to it
                    //var consent = confirm("");
                } else if(document.querySelector('#sell_toggle').checked) {
                    sell();
                } else if(document.querySelector('#buy_toggle').checked) {
                    buy();
                }
            }
            
            function sell() {
                var sel = document.querySelector("#sell_aktie");
                var aktie = sel.options[sel.selectedIndex].value;
                var amount = parseInt(document.querySelector("#sell_amount").value);
                
                socket.emit("sell_action", [aktie, amount]);
            };
            
            function buy() {
                var sel = document.querySelector("#buy_aktie");
                var aktie = sel.options[sel.selectedIndex].value;
                var amount = parseInt(document.querySelector("#buy_amount").value);
                
                socket.emit("buy_action", [aktie, amount]);
            };

            function populateDropdowns(e) { //Ask for list of stocks
                //console.log(JSON.stringify(status));
                var aktier = state['aktier'];
                var sel1 = document.getElementById(e + '_aktie');
                sel1.innerHTML = "";
                var fragment = document.createDocumentFragment();
                
                for (aktie in aktier ) {
                    var opt = document.createElement('option');
                    opt.innerHTML = aktie;
                    opt.value = aktie;
                    fragment.appendChild(opt);
                };
                
                sel1.appendChild(fragment);
                
                var toggleState = document.querySelector('#' + e + '_toggle').checked;
                var eitherState = document.querySelector('#buy_toggle').checked || document.querySelector('#sell_toggle').checked;
                document.querySelector('#' + e + '_div').style.display = (toggleState ? 'block' : 'none');
                document.querySelector('#do_action').style.display = (eitherState ? 'block' : 'none');
            }
            window.onload = function () {
            };
        </script>
        <h2>Hvad vil du gøre?</h2>
        <div><label><input id="sell_toggle" checked=false type=checkbox onclick="populateDropdowns('sell');"></input>Sælge!</label></div>
        <div id="sell_div" style="display:none">
            <select id="sell_aktie"></select>
            <input id="sell_amount" type="number" value=1>
        </div>

        <div><label><input id="buy_toggle" checked=false type=checkbox onclick="populateDropdowns('buy');"></input>Købe!</label></div>
        <div id="buy_div" style="display:none">
            <select id="buy_aktie"></select>
            <input id="buy_amount" type="number" value=1>
        </div>
        <button id="do_action" onclick="buy_sell_action()" style="display: none">Engage!</button>
        
        <div id="forecast" style="display: none;">
            <h2>Efter denne transaktion</h2>
            Vil du have <div id="nextMoney"></div> DKK.
        </div>
        
        <h2>Din status</h2>
        <div id="status"></div>
    </body>
</html>